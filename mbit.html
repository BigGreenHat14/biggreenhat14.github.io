<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>micro:bit Flash Test</title>
</head>
<body>
  <h1>micro:bit Flash from Link</h1>
  <input type="text" id="hexUrl" placeholder="Enter HEX file URL" size="50" />
  <button id="flashBtn">Flash to App</button>

  <script>
  // Helper: fetch binary file and convert to Base64
  async function fetchHexAsBase64(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error("Failed to fetch HEX file");
      const arrayBuffer = await response.arrayBuffer();
      let binary = '';
      const bytes = new Uint8Array(arrayBuffer);
      for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
  }

  async function flashHexFromUrl() {
      const url = document.getElementById("hexUrl").value.trim();
      if (!url) return alert("Enter a URL to a HEX file");

      try {
          const base64Hex = await fetchHexAsBase64(url);

          // Detect MakeCode Android app
          const isApp = new URLSearchParams(window.location.search).has('androidapp');

          if (isApp) {
              const msg = {
                  type: 'importfile',
                  filename: url.split("/").pop() || "program.hex",
                  parts: [ base64Hex ]
              };
              window.postMessage(msg, '*');
              alert("HEX sent to app for flashing!");
          } else {
              // Browser fallback: download
              const blob = new Blob([atob(base64Hex)], { type: 'application/octet-stream' });
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = url.split("/").pop() || "program.hex";
              a.click();
          }
      } catch (err) {
          console.error(err);
          alert("Error fetching or flashing HEX: " + err.message);
      }
  }

  document.getElementById("flashBtn").addEventListener("click", flashHexFromUrl);
  </script>
</body>
</html>
